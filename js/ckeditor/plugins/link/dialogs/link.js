CKEDITOR.dialog.add('link',function(editor){var emailRegex=/^mailto:([^?]+)(?:\?(.+))?$/,urlRegex=/^((?:http|https|ftp|news):\/\/)?(.*)$/,selectableTargets=/^(_(?:self|top|parent|blank))$/;var parseLink=function(editor,element){var href=element?(element.getAttribute('_cke_saved_href')||element.getAttribute('href')):'',emailMatch='',urlMatch=false,retval={};if(href){emailMatch=href.match(emailRegex);urlMatch=href.match(urlRegex)}retval.type='url';retval.url={};if(emailMatch){retval.url.url='mailto:'+emailMatch[1]}else if(href&&urlMatch){retval.url.url=urlMatch[1]+urlMatch[2]}this._.selectedElement=element;return retval};return{title:editor.lang.link.title,minWidth:420,minHeight:100,contents:[{id:'info',label:editor.lang.link.info,title:editor.lang.link.info,elements:[{type:'text',id:'url',label:editor.lang.link.linkurl,onLoad:function(){this.allowOnChange=true},validate:function(){var func=CKEDITOR.dialog.validate.notEmpty(editor.lang.link.noUrl);return func.apply(this)},setup:function(data){this.allowOnChange=false;if(data.url)this.setValue(data.url.url);this.allowOnChange=true},commit:function(data){if(!data.url)data.url={};data.url.url=this.getValue();this.allowOnChange=false}}]}],onShow:function(){var editor=this.getParentEditor(),selection=editor.getSelection(),ranges=selection.getRanges(),element=null;if(ranges.length==1){var rangeRoot=ranges[0].getCommonAncestor(true);element=rangeRoot.getAscendant('a',true);if(element&&element.getAttribute('href')){selection.selectElement(element)}else element=null}this.setupContent(parseLink.apply(this,[editor,element]))},onOk:function(){var attributes={href:'javascript:void(0)/*'+CKEDITOR.tools.getNextNumber()+'*/',target:'_blank'},data={href:attributes.href},editor=this.getParentEditor();this.commitContent(data);var url=(data.url&&data.url.url)||'';attributes._cke_saved_href=url;if(!this._.selectedElement){var selection=editor.getSelection(),ranges=selection.getRanges();if(ranges.length==1&&ranges[0].collapsed){var text=new CKEDITOR.dom.text(attributes._cke_saved_href,editor.document);ranges[0].insertNode(text);ranges[0].selectNodeContents(text);selection.selectRanges(ranges)}var style=new CKEDITOR.style({element:'a',attributes:attributes});style.type=CKEDITOR.STYLE_INLINE;style.apply(editor.document)}else{var element=this._.selectedElement;element.setAttributes(attributes);delete this._.selectedElement}}}});